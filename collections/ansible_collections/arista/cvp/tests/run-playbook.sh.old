#!/bin/sh

helpFunction()
{
   echo ""
   echo "Usage: $0 -p ansible-playbook-name -t Ansible-Target"
   echo -e "\t-p Ansible Playbook to test"
   echo -e "\t-p Ansible module to test"
   echo -e "\t-h CVP instance to target for testing"
   echo -e "\t-t Tag to run in Ansible playbook"
   exit 1 # Exit script after printing help
}

while getopts "p:m:h:t:" opt
do
   case "$opt" in
      m ) ANSIBLE_PLAYBOOK=$(echo "playbook."$OPTARG".demo.yaml") ;;
      p ) ANSIBLE_PLAYBOOK="$OPTARG" ;;
      h ) ANSIBLE_TARGET="$OPTARG" ;;
      t ) ANSIBLE_TAG="$OPTARG" ;;
      ? ) helpFunction ;; # Print helpFunction in case parameter is non-existent
   esac
done

# Print helpFunction in case parameters are empty
if [ -z "$ANSIBLE_PLAYBOOK" ] || [ -z "$ANSIBLE_TARGET" ]
then
   echo "Some or all of the parameters are empty";
   helpFunction
fi

ANSIBLE_BIN=$(which ansible-playbook)

PLAYBOOK_TITLE=$(cat $ANSIBLE_PLAYBOOK | grep -E "^- name:" | awk -F 'name:' '{print $2}' | sed -e 's/^[ \t]*//' )

echo "========================================================================="
echo ""
echo "Testing: $PLAYBOOK_TITLE ($ANSIBLE_PLAYBOOK)"
echo ""
# $ANSIBLE_BIN $ANSIBLE_PLAYBOOK --limit $ANSIBLE_TARGET
echo ""
echo "========================================================================="
